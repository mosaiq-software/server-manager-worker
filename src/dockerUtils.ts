import { RawDockerContainerData } from '@mosaiq/nsm-common/types';
import { execOnHost } from './execUtils';

export const listContainerData = async (): Promise<RawDockerContainerData[]> => {
    // .ID	Container ID
    // .Image	Image ID
    // .Command	Quoted command
    // .CreatedAt	Time when the container was created.
    // .RunningFor	Elapsed time since the container was started.
    // .Ports	Exposed ports.
    // .State	Container status (for example; "created", "running", "exited").
    // .Status	Container status with details about duration and health-status.
    // .Size	Container disk size.
    // .Names	Container names.
    // .Labels	All labels assigned to the container.
    // .Label	Value of a specific label for this container. For example '{{.Label "com.docker.swarm.cpu"}}'
    // .Mounts	Names of the volumes mounted in this container.
    // .Networks	Names of the networks attached to this container.
    const cmd = `docker ps --all --no-trunc --format json`;
    const { out, code } = await execOnHost(cmd, 1000 * 10);
    if (code !== 0) {
        throw new Error(`Error listing containers, code ${code}, out: ${out}`);
    }
    const json = `[${out.trim().replace(/\n/g, ',')}]`;

    return JSON.parse(json) as RawDockerContainerData[];
};

// const a = [
//     { Command: '"docker-entrypoint.sh tsx src/index.ts"', CreatedAt: '2025-09-07 11:05:35 -0400 EDT', ID: '32a6b0114406601a6a27eab478a82e278d73a9c2d80cce34a31739c0ccc05c7b', Image: 'nsm-api', Labels: 'com.docker.compose.image=sha256:f20e1260cd879aa8dbb24f14f802ae025279adeeea3ff2fbafc3710978db741c,com.docker.compose.oneoff=False,com.docker.compose.project.config_files=/home/camo/nsm/nsm/server-manager/docker-compose.yml,com.docker.compose.project.working_dir=/home/camo/nsm/nsm/server-manager,com.docker.compose.service=api,com.docker.compose.config-hash=2a1914cc79204c82aa2248f22376fc6a15abdd172f75bf00ac546d1b43a7feb4,com.docker.compose.container-number=3,com.docker.compose.depends_on=common-job:service_started:false,com.docker.compose.project=nsm,com.docker.compose.version=2.29.7', LocalVolumes: '0', Mounts: '/nsm/config/.ssh,/nsm/config/execout,/nsm/config/nginx,/nsm/config/sandbox,/etc/nsmexec,/media/drive3/nsm/persistence', Names: 'nsm-api-3', Networks: 'nsm_default', Ports: '', RunningFor: '12 hours ago', Size: '0B', State: 'created', Status: 'Created' },
//     { Command: '"docker-entrypoint.sh tsx src/index.ts"', CreatedAt: '2025-09-06 17:17:39 -0400 EDT', ID: '4ec34808b4b9d6f98c86e77a70967af68c9c8f9467f8850666e6938361d1bce9', Image: 'nsm-api', Labels: 'com.docker.compose.container-number=2,com.docker.compose.depends_on=common-job:service_started:false,com.docker.compose.image=sha256:f20e1260cd879aa8dbb24f14f802ae025279adeeea3ff2fbafc3710978db741c,com.docker.compose.project=nsm,com.docker.compose.project.working_dir=/nsm/nsm/server-manager,com.docker.compose.config-hash=2a1914cc79204c82aa2248f22376fc6a15abdd172f75bf00ac546d1b43a7feb4,com.docker.compose.project.config_files=/nsm/nsm/server-manager/docker-compose.yml,com.docker.compose.replace=b150a3cdc603b995a489b8651ee5b804d6736462ad8586f8d47fa5f8ced6f941,com.docker.compose.service=api,com.docker.compose.version=2.29.7,com.docker.compose.oneoff=False', LocalVolumes: '0', Mounts: '/nsm/config/execout,/nsm/config/nginx,/nsm/config/sandbox,/etc/nsmexec,/media/drive3/nsm/persistence,/nsm/config/.ssh', Names: 'nsm-api-2', Networks: 'nsm_default', Ports: '0.0.0.0:1025-\u003e1025/tcp, :::1025-\u003e1025/tcp', RunningFor: '30 hours ago', Size: '0B', State: 'running', Status: 'Up 30 hours (healthy)' },
//     { Command: '"docker-entrypoint.sh npm run build:prod"', CreatedAt: '2025-09-06 17:16:14 -0400 EDT', ID: '5f4a5d3a2b20aaa7e72ae5b8c230a95a33722302dd14256e977fd7cf0eec1668', Image: 'nsm-ui-job', Labels: 'com.docker.compose.project.config_files=/nsm/nsm/server-manager/docker-compose.yml,com.docker.compose.replace=1b21ade4fcbc8d38f3fefdd5a94cba29bb69dbcfe758c82ba68a0fcec96e7459,com.docker.compose.service=ui-job,com.docker.compose.version=2.29.7,com.docker.compose.container-number=1,com.docker.compose.depends_on=common-job:service_started:false,com.docker.compose.image=sha256:020a590c03ee887451970cd259c386b63385bf7526579fb77492d40c5fa4f80f,com.docker.compose.project.working_dir=/nsm/nsm/server-manager,com.docker.compose.config-hash=dd702e5c644b87eb28d90051389df37efe0154e42103bc1e1281d9d0e6cfb3f2,com.docker.compose.oneoff=False,com.docker.compose.project=nsm', LocalVolumes: '0', Mounts: '/media/drive3/nsm/www', Names: 'nsm-ui-job-1', Networks: 'nsm_default', Ports: '', RunningFor: '30 hours ago', Size: '0B', State: 'exited', Status: 'Exited (0) 12 hours ago' },
//     { Command: '"docker-entrypoint.sh tsx src/index.ts"', CreatedAt: '2025-09-04 22:27:58 -0400 EDT', ID: '6f742856bda2f6012e539ee0105954170c369db20e896097938fbe282edf1bba', Image: 'nsm-worker-worker', Labels: 'com.docker.compose.replace=93914a5fb5e6b25ce9dc78f371c2944a1bab47c4dd3033a9264009a2265a6f8b,com.docker.compose.depends_on=,com.docker.compose.project.config_files=/home/camo/nsm/nsm/server-manager-worker/docker-compose.yml,com.docker.compose.project.working_dir=/home/camo/nsm/nsm/server-manager-worker,com.docker.compose.oneoff=False,com.docker.compose.project=nsm-worker,com.docker.compose.service=worker,com.docker.compose.version=2.29.7,com.docker.compose.config-hash=66a25ff209939ef9391408b0515b9d7200c4354d41de9c99f9921dce0df8c019,com.docker.compose.container-number=1,com.docker.compose.image=sha256:4ea5ab836ff0bae2d383ce2cfbc948e86ff9bc8a057ce63ec3a97bd6dcdde6f9', LocalVolumes: '0', Mounts: '/etc/nsmexec,/media/drive3/nsm,/nsm/apps,/nsm/config/.ssh,/nsm/config/execout,/nsm/config/nginx', Names: 'nsm-worker-worker-1', Networks: 'nsm-worker_default', Ports: '0.0.0.0:1026-\u003e1026/tcp, :::1026-\u003e1026/tcp', RunningFor: '3 days ago', Size: '0B', State: 'running', Status: 'Up 3 days (healthy)' },
//     { Command: '"docker-entrypoint.sh tsx src/index.ts"', CreatedAt: '2025-09-04 21:40:32 -0400 EDT', ID: '48f2ef7617dd1e2d6d9cf78b0602f159adef76c007623711d8552af94a5d5731', Image: 'server-manager-api', Labels: 'com.docker.compose.container-number=1,com.docker.compose.image=sha256:a422ee325a202d42006b0bcdbebd65dfa3442f0bf920799a707669217d4901f9,com.docker.compose.oneoff=False,com.docker.compose.project=server-manager,com.docker.compose.version=2.29.7,com.docker.compose.config-hash=2a1914cc79204c82aa2248f22376fc6a15abdd172f75bf00ac546d1b43a7feb4,com.docker.compose.depends_on=common-job:service_started:false,com.docker.compose.project.config_files=/home/camo/nsm/nsm/server-manager/docker-compose.yml,com.docker.compose.project.working_dir=/home/camo/nsm/nsm/server-manager,com.docker.compose.service=api', LocalVolumes: '0', Mounts: '/nsm/config/.ssh,/nsm/config/execout,/nsm/config/nginx,/nsm/config/sandbox,/etc/nsmexec,/media/drive3/nsm/persistence', Names: 'server-manager-api-1', Networks: 'server-manager_default', Ports: '', RunningFor: '3 days ago', Size: '0B', State: 'created', Status: 'Created' },
//     { Command: '"docker-entrypoint.sh npm run publish:prod"', CreatedAt: '2025-09-04 21:40:31 -0400 EDT', ID: '3b1ce6092a5aabe92a99e8a753985c636c7ca29f36509ced28e926bed3b72351', Image: 'server-manager-common-job', Labels: 'com.docker.compose.project=server-manager,com.docker.compose.oneoff=False,com.docker.compose.project.config_files=/home/camo/nsm/nsm/server-manager/docker-compose.yml,com.docker.compose.project.working_dir=/home/camo/nsm/nsm/server-manager,com.docker.compose.service=common-job,com.docker.compose.config-hash=f85d43dfe6aebdcc005010847603e1e93856ad36bb54f8f5c12b01722890a2d3,com.docker.compose.container-number=1,com.docker.compose.depends_on=,com.docker.compose.image=sha256:983bc023492bd978cbe35ea76e5cc21f15aa18c69f1d8cd47e0ae446b5ce25f4,com.docker.compose.version=2.29.7', LocalVolumes: '0', Mounts: '', Names: 'server-manager-common-job-1', Networks: 'server-manager_default', Ports: '', RunningFor: '3 days ago', Size: '0B', State: 'exited', Status: 'Exited (0) 3 days ago' },
//     { Command: '"docker-entrypoint.sh npm run publish:prod"', CreatedAt: '2025-09-04 21:32:11 -0400 EDT', ID: '308e287b6fa4406c04f7515b006cd296f5661e737560652f266d608188303180', Image: 'nsm-common-job', Labels: 'com.docker.compose.project.config_files=/home/camo/nsm/nsm/server-manager/docker-compose.yml,com.docker.compose.replace=a17ced32a68ef8411dd1b10e054a317760b920059f8c73ed4eda8f4d45c52eef,com.docker.compose.version=2.29.7,com.docker.compose.config-hash=f85d43dfe6aebdcc005010847603e1e93856ad36bb54f8f5c12b01722890a2d3,com.docker.compose.image=sha256:00ba40fda7f1e935b5f3e784d7c236cd45f6824af229b6d067b8014757ffe003,com.docker.compose.project=nsm,com.docker.compose.project.working_dir=/home/camo/nsm/nsm/server-manager,com.docker.compose.service=common-job,com.docker.compose.container-number=1,com.docker.compose.depends_on=,com.docker.compose.oneoff=False', LocalVolumes: '0', Mounts: '', Names: 'nsm-common-job-1', Networks: 'nsm_default', Ports: '', RunningFor: '3 days ago', Size: '0B', State: 'exited', Status: 'Exited (0) 12 hours ago' },
//     { Command: '"docker-entrypoint.sh npm run start"', CreatedAt: '2025-08-24 00:37:05 -0400 EDT', ID: '3574ef24cd8f5772dd9844535d4d6bb11ee1c70b37d7109932f5b140da14131d', Image: 'tracker2025-matthaggertracker', Labels: 'com.docker.compose.config-hash=b9959e998d7a347bfd9d3e629ffd063510adb0ff2a2ba59b29bf51d1a38f09b3,com.docker.compose.oneoff=False,com.docker.compose.project.config_files=/webapps/matthagger/tracker2025/docker-compose.yml,com.docker.compose.version=2.29.7,com.docker.compose.container-number=1,com.docker.compose.depends_on=,com.docker.compose.image=sha256:a7cc6a7f8936b48a4176688d887bf67655b7a16d27284a8dcc1b7200f78aac8d,com.docker.compose.project=tracker2025,com.docker.compose.project.working_dir=/webapps/matthagger/tracker2025,com.docker.compose.service=matthaggertracker', LocalVolumes: '0', Mounts: '/media/drive3/persistence/matthagger-tracker', Names: 'matthaggertracker', Networks: 'tracker2025_default', Ports: '0.0.0.0:3100-\u003e3100/tcp, :::3100-\u003e3100/tcp', RunningFor: '2 weeks ago', Size: '0B', State: 'running', Status: 'Up 2 weeks' },
//     { Command: '"docker-entrypoint.sh npm run start"', CreatedAt: '2025-07-22 14:56:12 -0400 EDT', ID: '16b4190b1f3cbd1dcf6002c41095b3592ebd600ecdacf3e7fcf42274c0974a7d', Image: 'terrazzo-api-terrazzo-api', Labels: 'com.docker.compose.depends_on=,com.docker.compose.oneoff=False,com.docker.compose.project.config_files=/webapps/mosaiq/terrazzo-api/docker-compose.yml,com.docker.compose.version=2.29.7,com.docker.compose.config-hash=28e20889856f61b23ff12da97c8c6e05b143365491492df829ee2446c553b907,com.docker.compose.container-number=1,com.docker.compose.image=sha256:3f108648af10516d92faca082d81f62e00d14e501f0e1fd4e8799f6c69b4f7ce,com.docker.compose.project=terrazzo-api,com.docker.compose.project.working_dir=/webapps/mosaiq/terrazzo-api,com.docker.compose.replace=deef0a61015882ee4bdaba3ebf36030b54e584c012117654797df49c0c73eeba,com.docker.compose.service=terrazzo-api', LocalVolumes: '0', Mounts: '/webapps/mosaiq/terrazzo-api', Names: 'terrazzo-api', Networks: 'terrazzo-api_default', Ports: '0.0.0.0:9051-9053-\u003e9051-9053/tcp, :::9051-9053-\u003e9051-9053/tcp', RunningFor: '6 weeks ago', Size: '0B', State: 'running', Status: 'Up 6 weeks' },
//     { Command: '"docker-entrypoint.sh node ./bin/www"', CreatedAt: '2025-06-24 22:16:38 -0400 EDT', ID: '0ce09935a27d5e75ac59824863c00d0dbece6d18e23634deb85144795d70dcef', Image: 'link-preview-generator-server-link-preview-generator', Labels: 'com.docker.compose.depends_on=,com.docker.compose.project=link-preview-generator-server,com.docker.compose.project.config_files=/webapps/mosaiq/link-preview-generator-server/docker-compose.yml,com.docker.compose.service=link-preview-generator,com.docker.compose.project.working_dir=/webapps/mosaiq/link-preview-generator-server,com.docker.compose.version=2.29.7,com.docker.compose.config-hash=1655a437b1f1c631b8e3b90dba631223fe5763dc18e722f1e172abc5c6d225fe,com.docker.compose.container-number=1,com.docker.compose.image=sha256:709e692a301cf4958ed58f028fea371d10376587ced72f3b78ec238848d655de,com.docker.compose.oneoff=False', LocalVolumes: '0', Mounts: '', Names: 'link-preview-generator-server-link-preview-generator-1', Networks: 'link-preview-generator-server_default', Ports: '0.0.0.0:2025-\u003e3000/tcp, [::]:2025-\u003e3000/tcp', RunningFor: '2 months ago', Size: '0B', State: 'running', Status: 'Up 2 months' },
//     { Command: '"docker-entrypoint.sh npm run start"', CreatedAt: '2025-02-18 09:54:28 -0500 EST', ID: 'c4edb52fbf654fdd15344a5830a60cb7bd278b397b54e0471f23ccd1bcd1b0ab', Image: 'tile-bot-tilebot', Labels: 'com.docker.compose.container-number=1,com.docker.compose.image=sha256:7388c447fb48425f6444d0cc6d3fdace75fff165372a3a96c8c4c2fe6933c212,com.docker.compose.oneoff=False,com.docker.compose.project=tile-bot,com.docker.compose.project.config_files=/webapps/mosaiq/tile-bot/docker-compose.yml,com.docker.compose.project.working_dir=/webapps/mosaiq/tile-bot,com.docker.compose.service=tilebot,com.docker.compose.config-hash=01b19e0db8482974faadf7ef5e7409ca5733401aa12610ad8b6e9c70f3bdd85b,com.docker.compose.version=2.29.7,com.docker.compose.depends_on=', LocalVolumes: '1', Mounts: 'tile-bot_bot-db', Names: 'tilebot', Networks: 'tile-bot_default', Ports: '0.0.0.0:4125-\u003e4125/tcp, :::4125-\u003e4125/tcp', RunningFor: '6 months ago', Size: '0B', State: 'running', Status: 'Up 6 months' },
//     { Command: '"docker-entrypoint.sh npm run start"', CreatedAt: '2024-12-20 18:16:32 -0500 EST', ID: 'f1bf19b64e70a67c2cd2b5acae25e2a99dcdcb59f561b006ea073eea1239df6e', Image: 'apt-api-apt-api', Labels: 'com.docker.compose.depends_on=,com.docker.compose.project.config_files=/webapps/mosaiq/action-performance-tracker/apt-api/docker-compose.yml,com.docker.compose.version=2.29.7,com.docker.compose.config-hash=74ef60285bfd2c2e03674c9cd2a73485634bd63cf80669bef5d27e0e97e1b9dd,com.docker.compose.image=sha256:40fcab26a8dc246f455bc2716c8e3acc2279daa21fdb681dace0d38fd6e77f2a,com.docker.compose.oneoff=False,com.docker.compose.project=apt-api,com.docker.compose.project.working_dir=/webapps/mosaiq/action-performance-tracker/apt-api,com.docker.compose.service=apt-api,com.docker.compose.container-number=1', LocalVolumes: '1', Mounts: 'apt-api_apt-db', Names: 'apt-api-apt-api-1', Networks: 'apt-api_default', Ports: '0.0.0.0:4126-\u003e4126/tcp, :::4126-\u003e4126/tcp', RunningFor: '8 months ago', Size: '0B', State: 'running', Status: 'Up 8 months' },
// ];
